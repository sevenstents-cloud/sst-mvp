{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/eduardo.mendonca/Library/CloudStorage/GoogleDrive-sevenstents%40gmail.com/My%20Drive/Documentos-OneDrive-Mac/marketik.market/Lojinha/VB/MVP_VB_SST_V1/src/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\n\nif (!supabaseUrl || !supabaseKey) {\n  console.warn('Supabase URL or Key is missing. Please check your .env.local file.');\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseKey);\n"],"names":[],"mappings":";;;;AAEoB;AAFpB;;AAEA,MAAM;AACN,MAAM;AAEN;;AAIO,MAAM,WAAW,IAAA,iMAAY,EAAC,aAAa"}},
    {"offset": {"line": 23, "column": 0}, "map": {"version":3,"sources":["file:///Users/eduardo.mendonca/Library/CloudStorage/GoogleDrive-sevenstents%40gmail.com/My%20Drive/Documentos-OneDrive-Mac/marketik.market/Lojinha/VB/MVP_VB_SST_V1/src/contexts/AuthContext.tsx"],"sourcesContent":["'use client';\n\nimport { createContext, useContext, useEffect, useState } from 'react';\nimport { supabase } from '@/lib/supabase';\nimport { Session, User } from '@supabase/supabase-js';\nimport { useRouter, usePathname } from 'next/navigation';\n\ninterface UserProfile {\n    id: string;\n    email: string;\n    role: string;\n    two_factor_enabled: boolean;\n    two_factor_secret?: string;\n    empresa_id?: string;\n}\n\ninterface AuthContextType {\n    session: Session | null;\n    user: User | null;\n    profile: UserProfile | null;\n    isLoading: boolean;\n    is2FAVerified: boolean;\n    verify2FA: (code: string) => Promise<boolean>;\n    signOut: () => Promise<void>;\n}\n\nconst AuthContext = createContext<AuthContextType>({\n    session: null,\n    user: null,\n    profile: null,\n    isLoading: true,\n    is2FAVerified: false,\n    verify2FA: async () => false,\n    signOut: async () => { },\n});\n\nexport const useAuth = () => useContext(AuthContext);\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n    const [session, setSession] = useState<Session | null>(null);\n    const [user, setUser] = useState<User | null>(null);\n    const [profile, setProfile] = useState<UserProfile | null>(null);\n    const [isLoading, setIsLoading] = useState(true);\n    const [is2FAVerified, setIs2FAVerified] = useState(false);\n    const router = useRouter();\n    const pathname = usePathname();\n\n    useEffect(() => {\n        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {\n            setSession(session);\n            setUser(session?.user ?? null);\n\n            if (session?.user) {\n                await fetchProfile(session.user.id);\n            } else {\n                setProfile(null);\n                setIs2FAVerified(false);\n            }\n            setIsLoading(false);\n        });\n\n        return () => subscription.unsubscribe();\n    }, []);\n\n    // Route Protection Logic\n    useEffect(() => {\n        if (isLoading) return;\n\n        const isLoginPage = pathname === '/login';\n\n        // 1. If not logged in and not on login page, redirect to login\n        if (!session && !isLoginPage) {\n            router.push('/login');\n            return;\n        }\n\n        // 2. If logged in...\n        if (session) {\n            // Check 2FA requirement\n            const requires2FA = profile?.two_factor_enabled && !is2FAVerified;\n\n            if (isLoginPage) {\n                // If on login page and fully authorized (or 2FA not needed yet because login page handles it),\n                // we might want to redirect to home ONLY if completely verified.\n                // However, the Login Page handles the 2FA input flow. \n                // So if we are \"logged in\" (supabase session) but stuck in 2FA step, we should stay on Login page.\n                // If we are fully verified, go home.\n                if (!requires2FA) {\n                    router.push('/');\n                }\n            } else {\n                // If elsewhere, and we require 2FA but aren't verified, go back to login (where 2FA input is)\n                // Note: This relies on the fact that the Login page detects the existing session and prompts for 2FA.\n                if (requires2FA) {\n                    router.push('/login');\n                }\n            }\n        }\n    }, [session, isLoading, pathname, profile, is2FAVerified, router]);\n\n\n    async function fetchProfile(userId: string) {\n        try {\n            const { data, error } = await supabase\n                .from('usuarios')\n                .select('*')\n                .eq('id', userId)\n                .single();\n\n            if (error) {\n                console.error('Erro ao buscar perfil:', error);\n            } else {\n                setProfile(data);\n                if (!data.two_factor_enabled) {\n                    setIs2FAVerified(true);\n                }\n            }\n        } catch (err) {\n            console.error(err);\n        }\n    }\n\n    async function verify2FA(code: string): Promise<boolean> {\n        setIs2FAVerified(true);\n        return true;\n    }\n\n    const signOut = async () => {\n        await supabase.auth.signOut();\n        setIs2FAVerified(false);\n        setProfile(null);\n        router.push('/login');\n    };\n\n    return (\n        <AuthContext.Provider value={{ session, user, profile, isLoading, is2FAVerified, verify2FA, signOut }}>\n            {!isLoading && children}\n        </AuthContext.Provider>\n    );\n}\n"],"names":[],"mappings":";;;;;;;AAEA;AACA;AAEA;;;AALA;;;;AA0BA,MAAM,4BAAc,IAAA,8KAAa,EAAkB;IAC/C,SAAS;IACT,MAAM;IACN,SAAS;IACT,WAAW;IACX,eAAe;IACf,WAAW,UAAY;IACvB,SAAS,WAAc;AAC3B;AAEO,MAAM,UAAU;;IAAM,OAAA,IAAA,2KAAU,EAAC;AAAW;GAAtC;AAEN,SAAS,aAAa,EAAE,QAAQ,EAAiC;;IACpE,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAiB;IACvD,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,yKAAQ,EAAc;IAC9C,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAqB;IAC3D,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,yKAAQ,EAAC;IAC3C,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,yKAAQ,EAAC;IACnD,MAAM,SAAS,IAAA,kJAAS;IACxB,MAAM,WAAW,IAAA,oJAAW;IAE5B,IAAA,0KAAS;kCAAC;YACN,MAAM,EAAE,MAAM,EAAE,YAAY,EAAE,EAAE,GAAG,qIAAQ,CAAC,IAAI,CAAC,iBAAiB;0CAAC,OAAO,OAAO;oBAC7E,WAAW;oBACX,QAAQ,SAAS,QAAQ;oBAEzB,IAAI,SAAS,MAAM;wBACf,MAAM,aAAa,QAAQ,IAAI,CAAC,EAAE;oBACtC,OAAO;wBACH,WAAW;wBACX,iBAAiB;oBACrB;oBACA,aAAa;gBACjB;;YAEA;0CAAO,IAAM,aAAa,WAAW;;QACzC;iCAAG,EAAE;IAEL,yBAAyB;IACzB,IAAA,0KAAS;kCAAC;YACN,IAAI,WAAW;YAEf,MAAM,cAAc,aAAa;YAEjC,+DAA+D;YAC/D,IAAI,CAAC,WAAW,CAAC,aAAa;gBAC1B,OAAO,IAAI,CAAC;gBACZ;YACJ;YAEA,qBAAqB;YACrB,IAAI,SAAS;gBACT,wBAAwB;gBACxB,MAAM,cAAc,SAAS,sBAAsB,CAAC;gBAEpD,IAAI,aAAa;oBACb,+FAA+F;oBAC/F,iEAAiE;oBACjE,uDAAuD;oBACvD,mGAAmG;oBACnG,qCAAqC;oBACrC,IAAI,CAAC,aAAa;wBACd,OAAO,IAAI,CAAC;oBAChB;gBACJ,OAAO;oBACH,8FAA8F;oBAC9F,sGAAsG;oBACtG,IAAI,aAAa;wBACb,OAAO,IAAI,CAAC;oBAChB;gBACJ;YACJ;QACJ;iCAAG;QAAC;QAAS;QAAW;QAAU;QAAS;QAAe;KAAO;IAGjE,eAAe,aAAa,MAAc;QACtC,IAAI;YACA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,qIAAQ,CACjC,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,QACT,MAAM;YAEX,IAAI,OAAO;gBACP,QAAQ,KAAK,CAAC,0BAA0B;YAC5C,OAAO;gBACH,WAAW;gBACX,IAAI,CAAC,KAAK,kBAAkB,EAAE;oBAC1B,iBAAiB;gBACrB;YACJ;QACJ,EAAE,OAAO,KAAK;YACV,QAAQ,KAAK,CAAC;QAClB;IACJ;IAEA,eAAe,UAAU,IAAY;QACjC,iBAAiB;QACjB,OAAO;IACX;IAEA,MAAM,UAAU;QACZ,MAAM,qIAAQ,CAAC,IAAI,CAAC,OAAO;QAC3B,iBAAiB;QACjB,WAAW;QACX,OAAO,IAAI,CAAC;IAChB;IAEA,qBACI,6LAAC,YAAY,QAAQ;QAAC,OAAO;YAAE;YAAS;YAAM;YAAS;YAAW;YAAe;YAAW;QAAQ;kBAC/F,CAAC,aAAa;;;;;;AAG3B;IArGgB;;QAMG,kJAAS;QACP,oJAAW;;;KAPhB"}}]
}